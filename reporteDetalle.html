<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="js/jquery.min.js"  type='text/javascript'></script>
    <script src="js/qrcode.js"  type='text/javascript'></script>
    <link rel="stylesheet" href="css/reportes.css">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,800" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body onload="cargaDatos()">
    
    <div class="banner">
        <img src="jpg/imagen_fondo_kia_LOW.jpg" alt="" srcset="" id="imagenBack" class="imagenPortada">
        <!-- <img src="jpg/logo/1216_Kia_basic_logo_White_no_background.png" alt="" srcset="" class="logo" id="imagenLogo"> -->
    </div>
    <div class="cuerpo centrado">
        <div class="titulo"><B>REPORTE REGISTROS DIARIOS KIA</B></div>
            <div class="titulo">
                <b id="titulo" class="titu"></b> - 
                <span id="contador" class="contador"> 0 personas</span>
            </div>
            <div id="chart"></div>
        <br><br>
        
    </div>
        <button class="boton" onclick="regresar()">Regresar</button>
    <br><br><br>
    <script type="text/javascript">
        function regresar(){
            window.location.href = `reporte.html`;
        }

        async function cargaDatos(){

            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const diaEspecifico = urlParams.get('diaEspecifico')
            const reporte = urlParams.get('grafica')
            let tituloReporte = urlParams.get('titulo')
            

            let dataJson = {}
            //----------
            const settings = {
                method: 'GET',
                headers: {
                    Accept: 'application/json',
                    'Content-Type': 'application/json',
                }
            };
                
            try {
                const fetchResponse = await fetch(`https://mosaico.app:4000/Kia/graficaRegistrosPorHora?diaEspecifico=${diaEspecifico}`, settings);
                const tabledata = await fetchResponse.json();
                let resul = tabledata.statusCode
                /* let resul = 200; */
                if(resul == 200){
                    tituloReporte  = "Reporte de la fecha " + diaEspecifico
                    const etiqueta = dameTitulo(tituloReporte)
                const labelsFromTable = tabledata.message.map(data => data.fechaRegistro + " " + data.horaRegistro )
                const labels = labelsFromTable
                // const labels = await dameLabels(labelsFromTable)
                const dataManual = tabledata.message.map(data => data.Registrados)

                var count = dataManual.reduce((suma, actual)=> suma+actual)
                document.getElementById("titulo").innerHTML = etiqueta
                const element = document.getElementById("contador");
                element.innerHTML = 'NÃºmero de Registros: ' + count

                 // let context = document.getElementById('chart').getContext('2d')
                 var newCanvas = document.createElement('canvas');
                newCanvas.id = 'canv';
                newCanvas.height = window.innerHeight*0.65
                newCanvas.width = window.innerWidth
                document.getElementById('chart').appendChild(newCanvas);
                var context = newCanvas.getContext('2d'); // whatever type of context

                var gradient = context.createLinearGradient(0, 0, 0, 1000);
                gradient.addColorStop(0, "rgb(255,90,1)");
                gradient.addColorStop(0.15, "rgb(255,140,0)");
                gradient.addColorStop(0.25, "rgb(255,90,1)");
                gradient.addColorStop(0.5, "rgb(255,140,0)");
                gradient.addColorStop(0.75, "rgb(255,90,1)");
                gradient.addColorStop(1, "rgb(255,140,0)");

                const data = {
                    labels: labels,
                    datasets: [{
                        label: etiqueta,
                        backgroundColor: gradient,
                        borderColor: 'rgb(0,0,0)',
                        data: dataManual,
                        borderWidth : 2,
                    }]
                };
                // const config = {
                // labels: labels,
                // datasets: [
                //     {
                //         label: 'Registros',
                //         data: dataManual,
                //         borderColor: 'rgb(255, 99, 132)',
                //         backgroundColor: 'rgb(0, 255, 0)',
                //         borderWidth: 2,
                //         borderRadius: 5,
                //         borderSkipped: false,
                //     }
                // ]
                // };

                const config = {
                    type: 'bar',
                    data: data,
                }
                
                var chart = new Chart(context, config);

            }else{
                    console.log("Error: " + tabledata.message);  
                }
            } catch (e) {
                console.log("Error:" + e);
            }
            //----------
        }
        function dameTitulo(titulo){
            let nuevo = titulo.match(/([A-Z]?[^A-Z]*)/g).slice(0,-1).join(" ")    
            return nuevo.charAt(0).toUpperCase() + nuevo.slice(1)
        }   
    </script>
</body>
</html>